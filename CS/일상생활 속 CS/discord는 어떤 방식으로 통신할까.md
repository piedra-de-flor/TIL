# Discord 음성 통화의 작동 원리: 네트워크 관점

## 1. Discord 음성 통화란?
Discord 음성 통화는 전 세계 사용자들이 실시간으로 음성을 주고받을 수 있게 해주는 VoIP(Voice over IP) 서비스 
P2P 방식이 아닌 서버 릴레이(SFU) 구조를 사용하여 보안, 확장성, 품질을 확보

---

## 2. Discord 음성 통화 동작 순서

### 2.1 연결 및 세션 설정
1. 클라이언트가 Discord Gateway(WebSocket)에 연결하여 길드와 채널 상태 정보를 동기화
2. 음성 채널 입장 명령을 전송하면 서버가 Voice Server 접속 정보(IP, 포트, 토큰 등)를 반환
3. 클라이언트는 해당 Voice 서버에 별도의 WebSocket 연결을 개설
4. 서버가 SSRC, 암호화 모드, UDP 포트 등을 담은 Ready 이벤트를 전송

### 2.2 UDP 경로 확보
1. 클라이언트가 서버의 UDP 포트로 IP Discovery 패킷을 전송
    - IP Discovery 패킷은 클라이언트가 자신의 공인 IP와 포트를 파악하기 위해 Voice 서버에 보내는 특수한 UDP 패킷
2. 서버가 클라이언트의 공인 IP와 포트를 회신
3. 클라이언트가 Voice WebSocket에 select_protocol 메시지를 전송해 전송 경로와 암호화 모드를 확정

### 2.3 암호화 세션 생성
1. 서버가 session_description 이벤트를 통해 암호화 키(secret key)를 전달
2. 클라이언트는 RTP 헤더 기반 nonce를 생성
    - RTP 헤더 기반 nonce는 RTP 패킷의 고정된 헤더 데이터를 이용해 만들어지는 난수 시드 값으로, 암호화 과정에서 재사용되는 키 스트림 혼합 방지를 위해 사용
3. 생성된 nonce와 암호화 키를 사용해 XSalsa20-Poly1305 또는 AES-GCM 방식으로 암호화를 준비

### 2.4 음성 데이터 전송
1. 마이크 입력 데이터를 Opus 코덱으로 인코딩한다.
    - Opus는 낮은 비트레이트에서도 높은 음질을 제공하는 오디오 압축 포맷이며, 실시간 스트리밍에 최적화
2. 인코딩된 데이터에 RTP 헤더를 붙임
    - RTP(Real-time Transport Protocol)는 실시간 데이터 전송을 위해 시퀀스 번호, 타임스탬프, 동기화 소스를 포함하는 전송 계층 프로토콜
3. 패킷을 암호화한 후 UDP로 Voice 서버에 전송
    - UDP + RTP 조합은 TCP보다 지연이 적고 실시간성을 보장하며, 패킷 순서 및 타이밍은 RTP가 관리
4. Voice 서버(SFU)가 해당 패킷을 다른 참가자에게 중계
    - SFU(Selective Forwarding Unit)는 트랜스코딩 없이 받은 스트림을 선택적으로 전달하는 서버 구조다. 참여자 수가 많아도 효율적으로 대역폭을 사용할 수 있음

### 2.5 연결 유지 및 품질 제어
1. Voice WebSocket에서 하트비트를 주고받아 연결 상태를 확인
2. 서버는 Ping, Packet Loss, Jitter를 모니터링하여 품질을 조정
    - Ping: 클라이언트와 서버 간 왕복 지연 시간을 ms 단위로 측정한 값
    - Packet Loss: 전송 중 손실된 패킷 비율을 나타내며, 높을수록 음성 끊김이 심해짐
    - Jitter: 패킷 도착 간격의 변동을 의미하며, 높으면 오디오 지터버퍼에서 지연 보정이 필요
3. 침묵 구간에는 전송을 줄이는 VAD(Voice Activity Detection)를 적용

---

## 3. 사용 기술 및 프로토콜
- 제어 채널: TCP(WebSocket) – 세션 관리, 상태 이벤트, 암호화 키 교환
- 미디어 채널: UDP + RTP – 실시간 음성 데이터 전송. RTP는 시퀀스 번호, 타임스탬프를 포함해 순서 복원과 타이밍 조정이 가능
- 코덱: Opus – 고음질·저지연·낮은 비트레이트를 지원하는 오디오 압축 방식
- 암호화: XSalsa20-Poly1305 또는 AES-GCM. SRTP와 유사한 구조를 가지며, RTP 헤더 기반 nonce로 암호화 스트림을 보호
- 서버 구조: SFU(Selective Forwarding Unit) – 모든 참가자의 스트림을 받아 트랜스코딩 없이 선택적으로 전달

## 4. 주요 개념 설명

- SFU (Selective Forwarding Unit) \
서버가 받은 미디어 스트림을 그대로 다른 사용자에게 전달하는 구조. 서버에서 믹싱하지 않아 지연이 낮고 확장성이 좋음

- Ping \
네트워크 왕복 지연 시간을 측정하기 위한 작은 테스트 패킷. Discord는 주기적으로 서버와 클라이언트 간 Ping을 측정해 품질 조정에 사용

-  Loss \
전송 과정에서 손실된 패킷의 비율. 음성 통화에서는 손실율이 높으면 끊김 현상이 발생

- Jitter \
패킷 도착 시간 간격의 변동. 네트워크 혼잡이나 경로 변경 등으로 인해 발생하며, 오디오 품질 저하의 원인이 됨

- RTP 헤더 기반 nonce \ 
RTP 패킷의 헤더 정보를 기반으로 생성하는 고유 숫자. 암호화된 통신에서 패킷 무결성과 순서를 보장하는 데 사용

- IP Discovery 패킷 \
UDP를 이용해 자신의 퍼블릭 IP와 포트를 알아내는 절차. NAT 환경에서 외부 접근 가능 주소를 식별하는 데 필요

- UDP + RTP \ 
UDP는 연결 지향이 아니어서 지연이 낮으며, RTP는 오디오/비디오 실시간 전송을 위해 설계된 프로토콜. Discord는 이 조합을 사용해 실시간성을 보장

- Opus 코덱 \
음성 품질과 압축 효율이 우수한 오픈 소스 오디오 코덱. 네트워크 상태에 따라 비트레이트를 실시간 조정 가능

- 코덱 (Codec) \
아날로그 신호를 디지털로 변환(인코딩)하고, 다시 복원(디코딩)하는 알고리즘. 음성 통화에서는 대역폭 절약과 품질 유지에 중요

- SSRC \
Synchronization Source Identifier의 약자로, RTP(Real-time Transport Protocol)에서 스트림을 구분하기 위해 사용되는 32비트 식별자
