# 아이폰에서 동영상 파일 저장과 재생

## 1. 동영상 저장 방식
- 아이폰은 APFS(Apple File System) 사용
- 동영상 파일은 MP4, MOV, M4V 컨테이너 포맷으로 저장
- 내부에 오디오 스트림과 비디오 스트림이 압축된 상태로 공존
- NAND 플래시 메모리가 전자적 상태를 0과 1로 구분해 저장
- Copy-on-Write 방식으로 데이터 무결성 보장
- 스냅샷 기능으로 백업과 복원 지원

## 2. 파일 데이터 형태
- 모든 파일은 0과 1의 이진 데이터로 저장
- 동영상 파일도 바이트 단위의 이진 데이터 집합
- 특정 포맷 구조를 가진 컨테이너 형태
- 리틀 엔디안/빅 엔디안 바이트 순서 고려

### MP4 파일 구조
- ftyp: 파일 타입과 호환성 정보
- moov: 메타데이터 (코덱, 프레임 인덱스, 타임스탬프, 트랙 정보)
- mdat: 실제 압축된 오디오와 비디오 데이터
- free/skip: 여유 공간 또는 건너뛸 데이터
- udta: 사용자 정의 메타데이터
- mvhd: 동영상 헤더 (재생 시간, 생성일 등)

## 3. 파일 시스템의 자료구조 관점
- APFS는 B+ Tree 변형 구조로 파일 메타데이터 관리
- 파일 이름, 위치, 크기, 블록 포인터 정보를 메타데이터 노드에 저장
- 파일 데이터는 여러 블록으로 분할 저장
- Extent 기반 할당으로 연속된 블록 관리
- 압축과 암호화를 파일 시스템 레벨에서 지원
- 클론 파일로 공간 효율성 증대
- 64비트 inode 번호 사용

## 4. 데이터베이스(DB) 관점
- 동영상 파일 자체는 파일 시스템에 저장
- SQLite DB에 파일 경로, 썸네일, 메타데이터만 저장
- Photos.sqlite가 사진과 동영상 정보 관리
- 메타데이터: 촬영 일시, GPS 위치, 해상도, 프레임률, 파일 크기
- 페이스 인식, 장면 분석 결과도 DB에 저장
- 앨범, 즐겨찾기, 편집 히스토리 정보 포함
- Core Data 프레임워크로 객체-관계 매핑

## 5. 동영상 재생 과정
1. 앱이 파일 시스템을 통해 동영상 파일 열기
2. 파일 포맷 파서가 MP4, MOV, HEIF 구조 해석
3. 비디오 스트림을 H.264, H.265(HEVC), AV1 디코더로 복원
4. 오디오 스트림을 AAC, ALAC, Dolby 디코더로 복원
5. GPU 가속을 통한 하드웨어 디코딩 활용
6. 프레임 버퍼에 비디오 프레임 저장
7. 오디오 버퍼에 오디오 샘플 저장
8. 타임스탬프 기반으로 오디오-비디오 동기화
9. 디스플레이 컨트롤러가 화면에 출력
10. 오디오 드라이버가 스피커로 출력

## 6. 압축 및 코덱
- 비디오 코덱: H.264, H.265, ProRes, Apple ProRAW
- 오디오 코덱: AAC, ALAC, MP3, Dolby Atmos
- 컨테이너: MP4, MOV, M4V, MKV 지원
- HDR: HDR10, Dolby Vision 지원
- 가변 비트레이트(VBR)와 고정 비트레이트(CBR) 인코딩

## 7. 메모리 관리
- 동영상 재생 시 메모리 풀 사용
- 버퍼링을 통한 끊김 없는 재생
- 메모리 압박 시 백그라운드 앱 종료
- ARC(Automatic Reference Counting)로 메모리 해제

## 8. 개념 설명

### NAND 플래시 메모리
- 전기적 신호로 데이터를 저장하는 비휘발성 반도체 메모리
- 셀 단위로 전하를 저장하여 0과 1을 구분
- SLC(Single), MLC(Multi), TLC(Triple), QLC(Quad) 레벨 셀로 구분
- 프로그램/삭제 사이클 제한이 있어 웨어 레벨링 필요

### Copy-on-Write 방식
- 데이터 복사 시 실제로는 복사하지 않고 참조만 공유
- 수정이 발생할 때만 실제 복사 수행
- 메모리와 저장공간 효율성 증대
- 스냅샷과 클론 기능의 기반 기술

### 리틀 엔디안/빅 엔디안 바이트 순서
- 멀티바이트 데이터의 저장 순서 방식
- 리틀 엔디안: 최하위 바이트부터 저장 (Intel x86)
- 빅 엔디안: 최상위 바이트부터 저장 (네트워크 바이트 순서)
- 플랫폼 간 데이터 교환 시 고려 필요

### B+ Tree 변형 구조
- 균형잡힌 다진 탐색 트리의 개선된 형태
- 모든 데이터를 리프 노드에만 저장
- 내부 노드는 인덱스 역할만 수행
- 순차 탐색과 범위 검색에 최적화
- 파일 시스템과 데이터베이스에서 광범위하게 사용

### Extent 기반 할당
- 연속된 블록들의 집합을 하나의 단위로 할당
- 시작 블록 번호와 길이로 표현
- 파편화 감소 및 성능 향상
- 대용량 파일의 효율적 관리 가능

### 블록 포인터
- 파일 데이터가 저장된 디스크 블록의 주소를 가리키는 값
- 직접 포인터, 간접 포인터, 이중 간접 포인터로 구분
- 파일 크기에 따라 다단계 포인터 구조 사용
- 파일 시스템의 핵심 주소 지정 메커니즘

### inode 번호
- 파일이나 디렉토리를 유일하게 식별하는 번호
- 파일 메타데이터(권한, 소유자, 크기, 타임스탬프)를 포함
- 파일명과 독립적으로 존재하여 하드링크 지원
- APFS에서는 64비트 inode로 확장

### SQLite DB
- 임베디드용 경량 관계형 데이터베이스 엔진
- 서버가 필요 없는 파일 기반 데이터베이스
- ACID 특성을 지원하여 데이터 무결성 보장
- iOS에서 Core Data, 앱 설정, 미디어 라이브러리에 사용

### H.264
- MPEG-4 Part 10으로도 알려진 비디오 압축 표준
- 고압축률과 고품질을 동시에 제공
- 움직임 보상과 DCT 변환 기반
- 웹, 방송, 모바일에서 널리 사용

### H.265(HEVC)
- H.264의 후속 표준으로 압축률이 약 50% 향상
- 4K, 8K 고해상도 비디오에 최적화
- 더 복잡한 인코딩으로 처리 성능 요구량 증가
- 라이센스 비용으로 인한 도입 제약 존재

### AV1 디코더
- Google, Mozilla, Netflix 등이 개발한 로열티 프리 코덱
- H.265 대비 30% 추가 압축률 향상
- 웹 스트리밍과 모바일에 특화
- 하드웨어 지원이 점진적으로 확산

### AAC
- Advanced Audio Coding의 줄임말
- MP3보다 우수한 음질과 압축률 제공
- 다채널 오디오와 고음질 지원
- Apple 기기에서 표준 오디오 포맷

### ALAC
- Apple Lossless Audio Codec의 줄임말
- 무손실 오디오 압축 방식
- 원본 음질을 100% 보존
- Apple 생태계에서 고음질 오디오용

### Dolby 디코더
- Dolby Digital, Dolby Atmos 등 서라운드 사운드 처리
- 다채널 오디오의 공간감과 몰입감 제공
- 영화관과 가정용 오디오 시스템에 널리 사용
- 객체 기반 오디오로 3D 음향 효과 구현

### ARC(Automatic Reference Counting)
- Objective-C와 Swift에서 사용하는 메모리 관리 기법
- 객체의 참조 횟수를 자동으로 추적하여 메모리 해제
- 가비지 컬렉션보다 예측 가능한 성능 제공
- 순환 참조 문제 해결을 위해 weak, unowned 참조 사용